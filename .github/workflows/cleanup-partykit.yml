name: Cleanup PartyKit Preview

on:
  delete:

env:
  CI: true

jobs:
  cleanup:
    # Only run for branch deletions, not tag deletions
    if: github.event.ref_type == 'branch'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main  # Checkout main since the branch is deleted
      
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - run: npm ci
      
      - name: Delete PartyKit preview deployment
        run: |
          BRANCH_NAME="${{ github.event.ref }}"
          BRANCH_NAME="${BRANCH_NAME//\//-}"
          echo "üóëÔ∏è Deleting PartyKit deployment: ski-fall-${BRANCH_NAME}"
          npx partykit delete --name "ski-fall-${BRANCH_NAME}" --force || echo "Deployment may not exist, continuing..."
        env:
          PARTYKIT_LOGIN: ${{ secrets.PARTYKIT_LOGIN }}
          PARTYKIT_TOKEN: ${{ secrets.PARTYKIT_TOKEN }}

